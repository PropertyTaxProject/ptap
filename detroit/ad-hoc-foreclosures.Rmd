---
title: "Detroit Foreclosures"
author: "Eric Langowski"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    df_print: paged
    theme: sandstone
    number_sections: true
---


```{r include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 6,
  fig.height = 5
)

library(tidyverse)
library(kableExtra)
library(scales)
library(ggplot2)

f17 <- read_csv("detroit/data/2017 (1).csv") %>% 
  select(Parcel, `Auction Status`, `Address`, `Use Type`, Owner, SEV) %>% 
  mutate(year = 2017,
         parcel = Parcel,
         status = `Auction Status`,
         prop_addr = Address,
         class = `Use Type`,
         owner = Owner,
         sev = SEV) %>%
  select(year:sev)

f18 <- read_csv("detroit/data/2018 (1).csv") %>% 
  select(`Parcel ID`, Address, Status) %>% 
  mutate(year = 2018,
         parcel = `Parcel ID`,
         status = Status,
         prop_addr = Address,
         class = NA,
         owner = NA,
         sev = NA) %>%
  select(year:sev)

f19 <- read_csv("detroit/data/2019-wayne-county-tax-foreclosure-auction-detroit-mi.csv") %>%
  select(parcel_id, address, status, owner, address_1, property_class, parval) %>% 
  mutate(year = 2019,
         parcel = parcel_id,
         status = status,
         prop_addr = address,
         class = property_class,
         owner = owner,
         sev = parval) %>%
  select(year, parcel, status, prop_addr, class, owner, sev)

total <- rbind(f17, f18, f19)
```


# Foreclosure Freeze Proposal

Our proposal is that foreclosures should be frozen for owner occupied properties with SEV less than 12500. Based on data from 2017 and 2019, these residential properties account for only about 27% of all sold or bundled foreclosed properties.

```{r}
pct_data <- 
  total %>% mutate(
  sold_or_bundled = ifelse(status %in% c("Bundled", "Sold"), 1, 0),
  own_occp = ifelse(!grepl('LLC|llc|BANK|bank|INC|inc|DETROIT|detroit|HUD|FANNIE MAE|L.P', owner), 1, 0),
  under_12500 = ifelse(sev <= 12500, 1, 0),
  res = ifelse(class %in% c("occupied", 401), 1, 0),
  res_under_oo = ifelse(own_occp == 1 & under_12500 == 1 & res == 1, 1, 0)
) %>% group_by(year, sold_or_bundled) %>%
  summarize(number = sum(res_under_oo),
            pct_num = mean(res_under_oo),
            total = n())
```

The following tables show the number of listings in the auction which meet the following criteria:

- <12500 SEV (OO): Properties with SEV less than 12500 and are owner occupied
- <12500 SERV (OO, BS): Properties either bundled or sold with SEV less than 12500 and owner occupied

```{r}
total_mini <- total %>% filter(year != 2018, 
                               class %in% c("occupied", 401))

total_mini <- total_mini %>%
  mutate(
    under_12500 = ifelse(sev <= 12500, 1, 0),
    under_7500 = ifelse(sev <= 7500, 1, 0),
    own_occp = ifelse(!grepl('LLC|llc|BANK|bank|INC|inc|DETROIT|detroit|HUD|FANNIE MAE|L.P', owner), 1, 0),
    sold_or_bundled = ifelse(status %in% c("Bundled", "Sold"), 1, 0),
    under_12500_oo = ifelse(under_12500 == 1 & own_occp == 1, 1, 0),
    under_7500_oo = ifelse(under_7500 == 1 & own_occp == 1, 1, 0),
    under_12500_oo_sb = ifelse(under_12500_oo == 1 & sold_or_bundled == 1, 1, 0),
    under_7500_oo_sb = ifelse(under_7500_oo == 1 & sold_or_bundled == 1, 1, 0)
  )

t2 <- 
  total_mini %>%
  group_by(year) %>%
  summarize(`<12500 SEV (OO)` = sum(under_12500_oo),
            #`<7500 SEV (OO)` = sum(under_7500_oo),
            `<12500 SEV (OO, BS)` = sum(under_12500_oo_sb),
            #`<7500 SEV (OO, BS)` = sum(under_7500_oo_sb),
            `<12500 SEV (OO, pct)` = percent(mean(under_12500_oo)),
            #`<7500 SEV (OO, pct)` = percent(mean(under_7500_oo)),
            `<12500 SEV (OO, BS, pct)` = percent(mean(under_12500_oo_sb)),
            #`<7500 SEV (OO, BS, pct)` = percent(mean(under_7500_oo_sb)),
            `All Less than 12500` = sum(under_12500),
            Total = n())

kable(t2 %>% select(year, Total, `All Less than 12500`, `<12500 SEV (OO)`:`<12500 SEV (OO, BS)`)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)


kable(t2 %>% select(year, Total, `All Less than 12500`, `<12500 SEV (OO, pct)`:`<12500 SEV (OO, BS, pct)`)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)


t2_long <-
  t2 %>% select(year, `<12500 SEV (OO)`, 
                #`<7500 SEV (OO)`, 
                `<12500 SEV (OO, BS)`,
             # `<7500 SEV (OO, BS)`, 
              Total) %>% pivot_longer(-year)

t2_long <- 
  t2_long %>% mutate(name = case_when(name == "<12500 SEV (OO)" ~ "Owner Occ.",
                                    name == "<12500 SEV (OO, BS)" ~ "O.O. and Sold/Bundled",
                                    TRUE ~ name))
```


### Residential Properties with SEV less than 12,500 (2017)

```{r}
ggplot(t2_long %>% filter(year==2017), aes(y=value)) +
  geom_bar(aes(x=reorder(name, -value)), stat='identity') +
  theme_classic(base_size=20) + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5),
                                      axis.title.y = element_blank(),
                                      axis.title.x = element_blank())
```

### Residential Properties with SEV less than 12,500 (2019)

```{r}
ggplot(t2_long %>% filter(year==2019), aes(y=value)) +
  geom_bar(aes(x=reorder(name, -value)), stat='identity') +
  theme_classic(base_size=20) + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5),
                                      axis.title.y = element_blank(),
                                      axis.title.x = element_blank())
```



# Foreclosure Outcomes

```{r}
t1 <- total %>% group_by(year) %>% count(status) %>% pivot_wider(names_from = status, values_from = n)

kable(t1) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)
```



# Withdrawn Properties

Top owners of withdrawn properties (including all property types).

```{r}
total_w <- total %>% filter(status == "Withdrawn") %>%
  mutate(own_occp = ifelse(!grepl('LLC|llc|BANK|bank|INC|inc|DETROIT|detroit|HUD|FANNIE MAE|L.P', owner), 1, 0))

all_w <- total_w %>% count(owner) %>% arrange(-n) %>% filter(!is.na(owner))

kable(all_w[c(1:15),]) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)
```

Top owners of residential withdrawn properties by year.

```{r}
total_miniw <- total %>% filter(class %in% c("occupied", 401),
                                status %in% c("Withdrawn"))

all_r_w <- total_miniw %>% group_by(year) %>% count(owner) %>% arrange(-n) %>% filter(!is.na(owner))

kable(all_r_w %>% filter(year == 2017) %>% top_n(10)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

kable(all_r_w %>% filter(year == 2019) %>% top_n(10)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)

#send email about 2018 data, 2017 data
```

