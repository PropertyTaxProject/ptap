---
title: "Detroit Rental Ordinance"
author: "Eric Langowski"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    df_print: paged
    theme: sandstone
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 7, fig.height = 5)

library(tidyverse)
library(scales)
library(kableExtra)
library(ggplot2)
library(lubridate)

data <- read_csv("rentalordinance.csv")

rental_data <- data %>% filter(!is.na(rental_status))
```

# Inspections & Registered Rentals Since Jan 2019

Based on [this map](https://detroitmi.gov/webapp/rental-map), properties which are registered as a rental but do not have a valid inspection are marked as non-compliant and properties with a valid inspection are marked as compliant. The City additionally issues blight tickets for failing to register as a rental property and for failing to obtain a certificate of compliance.


```{r}
kable(rental_data %>% 
        count(rental_status) %>% filter(rental_status != -1) %>%
        mutate(compliance = ifelse(rental_status == 1, "Compliant", "Non-compliant"),
               `Percent Compliant (Est.)` = percent(n/sum(n))) %>%
        select(-rental_status),
      ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  )
```



# Inspections & Registered Rentals by Month

```{r}
inspection_time <- 
  rental_data %>% group_by(month=floor_date(inspection_date, "month")) %>%
   summarize(amount=sum(inspection)) %>% filter(!is.na(month))


ggplot(inspection_time, aes(month, amount)) + geom_point(color='grey', size=3) +
  geom_line(size=2) + 
  labs(x="Month", y="Number of Inspection") +
  scale_x_datetime(breaks = "2 months", date_labels ="%m/%y") +
  theme_classic() 

rental_time <- 
  rental_data %>% group_by(month=floor_date(rental_date, "month")) %>%
   summarize(amount=sum(rental)) %>% filter(!is.na(month))


ggplot(rental_time, aes(month, amount)) + geom_point(color='grey', size=3) +
  geom_line(size=2) + 
  labs(x="Month", y="Number of New Rentals") +
  scale_x_datetime(breaks = "2 months", date_labels ="%m/%y") +
  theme_classic() 
  
```

# A Case Study

The largest non-compliant property is a huge apartment complex at 500 Kitchener (Parcel 21047891-925). Could be worth further investigation.

# Blight Tickets since 2017

```{r}
t1 <- rental_data %>% count(`Failure to obtain certificate of registration for rental property`) %>% filter(`Failure to obtain certificate of registration for rental property` == 1)
t2 <- rental_data %>% count(`Failure of owner to obtain certificate of compliance`) %>% filter(`Failure of owner to obtain certificate of compliance` == 1)

kable(t1) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  )

kable(t2) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  )
```




# Data Notes

This combines multiple open data sets which all have different limitations.

The City releases information on new rental registrations only since January 1, 2019. The City also releases data on successful inspections only. The City also releases information on properties which received a blight ticket for failing to register as a rental property and for failing to receive a certificate of compliance. Tickets issued since 2017 are included.


```{r eval=FALSE}
rentaldata <- read_csv('Detroit/data/misc/rentalordinance.csv')

tmp <- rentaldata %>% filter(property_1 %in% c("RESIDENTIAL", "RESIDENTIAL VACANT")) 

counts <- tmp %>% count(taxpayer_1, property_1) %>% pivot_wider(id_cols = taxpayer_1, names_from = property_1, values_from=n, values_fill=0)
counts <- counts %>% mutate(total = RESIDENTIAL + `RESIDENTIAL VACANT`)
rslt <- counts %>% filter(total >= 20)
rslt %>% filter(RESIDENTIAL >= 20)

rslt2 <- tmp %>% filter(property_1 == "RESIDENTIAL") %>% count(taxpayer_1, rental_status) %>% 
  pivot_wider(id_cols = taxpayer_1, names_from = rental_status, values_from=n, values_fill=0)

rslt2 <- rslt2 %>% mutate(valid = `1`, invalid_or_missing = `NA` + `-1` + `0`, total=valid+invalid_or_missing) %>% 
  select(taxpayer_1, valid, invalid_or_missing, total)%>% mutate(pct_valid = valid/total)

rslt2 <- rslt2 %>% filter(total >= 20) %>% arrange(-total)

rslt2 %>% write_csv('largeowners.csv')

```


